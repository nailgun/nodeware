var mc = require('mc'),
    path = require('path'),
    throws = require('nw.utils').throws;

function Connection (client) {
    var connection = {};

    connection.get = function (key, callback) {
        client.get(key, function (err, value) {
            if (err) {
                if (err.type === 'NOT_FOUND') {
                    return callback(undefined);
                } else {
                    throw err;
                }
            }
            callback(value[key]);
        });
    };

    connection.set = function (key, value, expires, callback) {
        if (expires) {
            expires = Math.ceil(expires/1000);
            if (expires < 1) {
                expires = 1;
            } else if (expires > 60*60*24*30) {
                expires = Math.ceil(new Date.getTime() / 1000) + expires;
            }
        }
        client.set(key, value, {
            exptime: expires
        }, throws(callback));
    };

    connection.invalidate = function (key, callback) {
        client.del(key, throws(callback));
    };

    return connection;
};

module.exports = function (opts, callback) {
    var servers = opts.servers || opts.server;
    var client = new mc.Client(servers);
    client.connect(throws(function () {
        callback(Connection(client));
    }));
};
